(window.webpackJsonp=window.webpackJsonp||[]).push([[46],{366:function(t,s,a){"use strict";a.r(s);var n=a(7),e=Object(n.a)({},(function(){var t=this,s=t._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:"内存相关原理"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#内存相关原理"}},[t._v("#")]),t._v(" 内存相关原理")]),t._v(" "),s("p",[t._v("HybridCLR是CLR级别的实现，因此热更新的脚本，除了执行代码是以解释模式执行，其他方式跟AOT部分完全相同的。")]),t._v(" "),s("h2",{attrs:{id:"对象内存大小"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#对象内存大小"}},[t._v("#")]),t._v(" 对象内存大小")]),t._v(" "),s("p",[t._v("对于值类型，对象大小并不是简单为所有成员所占大小，必须考虑到内存对齐。对于引用类型，多了额外了对象头(16字节)，并且内存对齐为8字节。对于array类型，则更为复杂。")]),t._v(" "),s("h3",{attrs:{id:"primitive-type"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#primitive-type"}},[t._v("#")]),t._v(" primitive type")]),t._v(" "),s("p",[t._v("如byte,int。如熟知， byte占1字节,int占4字节，其他不赘述。")]),t._v(" "),s("h3",{attrs:{id:"struct值类型"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#struct值类型"}},[t._v("#")]),t._v(" struct值类型")]),t._v(" "),s("p",[t._v("在未指定Explicit Layout的情况下，根据字段大小及内存对齐规则计算出总大小，与c++的struct计算规则相似。这里不详细阐述，直接举例吧。")]),t._v(" "),s("div",{staticClass:"language-csharp line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-csharp"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// V1 对象大小 1")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("V1")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("byte")])]),t._v(" a1"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// V2 对象大小 8")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("V2")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("byte")])]),t._v(" a1"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")])]),t._v(" a2"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// V3 对象大小 24")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("V3")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")])]),t._v(" a1"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")])]),t._v(" a2"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("object")])]),t._v(" a3"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("byte")])]),t._v(" a4"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br"),s("span",{staticClass:"line-number"},[t._v("12")]),s("br"),s("span",{staticClass:"line-number"},[t._v("13")]),s("br"),s("span",{staticClass:"line-number"},[t._v("14")]),s("br"),s("span",{staticClass:"line-number"},[t._v("15")]),s("br"),s("span",{staticClass:"line-number"},[t._v("16")]),s("br"),s("span",{staticClass:"line-number"},[t._v("17")]),s("br"),s("span",{staticClass:"line-number"},[t._v("18")]),s("br"),s("span",{staticClass:"line-number"},[t._v("19")]),s("br"),s("span",{staticClass:"line-number"},[t._v("20")]),s("br"),s("span",{staticClass:"line-number"},[t._v("21")]),s("br")])]),s("h3",{attrs:{id:"class-类型"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#class-类型"}},[t._v("#")]),t._v(" class 类型")]),t._v(" "),s("p",[t._v("与值类型相似，但多了对象头的16字节，并且强制内存对齐为8字节。示例:")]),t._v(" "),s("div",{staticClass:"language-csharp line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-csharp"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// C1 对象大小 24")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("C1")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("byte")])]),t._v(" a1"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// C2 对象大小 24")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("C2")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("byte")])]),t._v(" a1"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")])]),t._v(" a2"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// C3 对象大小 40")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("C3")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")])]),t._v(" a1"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")])]),t._v(" a2"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("object")])]),t._v(" a3"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("byte")])]),t._v(" a4"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br"),s("span",{staticClass:"line-number"},[t._v("12")]),s("br"),s("span",{staticClass:"line-number"},[t._v("13")]),s("br"),s("span",{staticClass:"line-number"},[t._v("14")]),s("br"),s("span",{staticClass:"line-number"},[t._v("15")]),s("br"),s("span",{staticClass:"line-number"},[t._v("16")]),s("br"),s("span",{staticClass:"line-number"},[t._v("17")]),s("br"),s("span",{staticClass:"line-number"},[t._v("18")]),s("br"),s("span",{staticClass:"line-number"},[t._v("19")]),s("br")])]),s("h2",{attrs:{id:"与lua、ilruntime的对象内存大小对比"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#与lua、ilruntime的对象内存大小对比"}},[t._v("#")]),t._v(" 与lua、ILRuntime的对象内存大小对比")]),t._v(" "),s("p",[t._v("lua的计算规则略复杂，参见"),s("a",{attrs:{href:"https://www.linuxidc.com/Linux/2018-10/154971.htm",target:"_blank",rel:"noopener noreferrer"}},[t._v("第三方文章"),s("OutboundLink")],1),t._v("。空table占56字节，每多一个字段至少多占32字节。")]),t._v(" "),s("p",[t._v("ILRuntime的类型除了enum外统一以IlTypeInstance表达，空类型占72字节，每多一个字段至少多用16字节。如果对象中包含引用类型数据，则整体又至少多24字节，并且每多一个object字段多8字节。")]),t._v(" "),s("table",[s("thead",[s("tr",[s("th",{staticStyle:{"text-align":"center"}},[t._v("类型")]),t._v(" "),s("th",{staticStyle:{"text-align":"center"}},[t._v("Xlua")]),t._v(" "),s("th",{staticStyle:{"text-align":"center"}},[t._v("ILRuntime")]),t._v(" "),s("th",{staticStyle:{"text-align":"center"}},[t._v("HybridCLR")])])]),t._v(" "),s("tbody",[s("tr",[s("td",{staticStyle:{"text-align":"center"}},[t._v("V1")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("88+")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("88")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("1")])]),t._v(" "),s("tr",[s("td",{staticStyle:{"text-align":"center"}},[t._v("V2")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("120+")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("104")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("8")])]),t._v(" "),s("tr",[s("td",{staticStyle:{"text-align":"center"}},[t._v("V3")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("184+")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("168")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("24")])]),t._v(" "),s("tr",[s("td",{staticStyle:{"text-align":"center"}},[t._v("C1")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("88+")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("88")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("24")])]),t._v(" "),s("tr",[s("td",{staticStyle:{"text-align":"center"}},[t._v("C2")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("120+")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("104")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("24")])]),t._v(" "),s("tr",[s("td",{staticStyle:{"text-align":"center"}},[t._v("C3")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("184+")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("168")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("40")])])])]),t._v(" "),s("h2",{attrs:{id:"运行过程中gc"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#运行过程中gc"}},[t._v("#")]),t._v(" 运行过程中GC")]),t._v(" "),s("p",[t._v("HybridCLR严格按照规范实现，除了assembly加载和函数第一次transfrom时会额外消耗CPU和内存外，运行时消耗的内存跟il2cpp完全相同。")]),t._v(" "),s("p",[t._v("因此你不要再问诸如 "),s("code",[t._v("foreach 循环会不会产生GC")]),t._v(" 这样的问题。在il2cpp或mono下产生多少GC，在HybridCLR中解释执行时也产生完全相同的GC。")])])}),[],!1,null,null,null);s.default=e.exports}}]);