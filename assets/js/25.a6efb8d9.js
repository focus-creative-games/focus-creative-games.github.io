(window.webpackJsonp=window.webpackJsonp||[]).push([[25],{345:function(s,t,a){"use strict";a.r(t);var n=a(7),e=Object(n.a)({},(function(){var s=this,t=s._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h1",{attrs:{id:"处理aot泛型"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#处理aot泛型"}},[s._v("#")]),s._v(" 处理AOT泛型")]),s._v(" "),t("p",[s._v("你的热更新代码中总会用到一些主工程中没有用过的泛型，例如你在热更新里有如下代码")]),s._v(" "),t("div",{staticClass:"language-csharp line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-csharp"}},[t("code",[s._v("  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("struct")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("MyIntVec3")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")])]),s._v(" x"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")])]),s._v(" y"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")])]),s._v(" z"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n  "),t("span",{pre:!0,attrs:{class:"token class-name"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("var")])]),s._v(" list "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token constructor-invocation class-name"}},[s._v("List"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("MyIntVec3"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  list"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("Add")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token constructor-invocation class-name"}},[s._v("MyIntVec3")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("x "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n  "),t("span",{pre:!0,attrs:{class:"token class-name"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("var")])]),s._v(" arr "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" Array"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token generic-method"}},[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("Empty")]),t("span",{pre:!0,attrs:{class:"token generic class-name"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("MyIntVec3"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br")])]),t("p",[s._v("由于"),t("code",[s._v("List<MyIntVec3>")]),s._v("或"),t("code",[s._v("Array.Empty<MyIntVec3>")]),s._v(" 从未在AOT中出现过，如果未做任何处理，你是无法在热更新中运行这些代码的。")]),s._v(" "),t("p",[s._v("HybridCLR使用"),t("code",[s._v("补充元数据技术")]),s._v("彻底解决了这个问题，详细原理请自己查看"),t("RouterLink",{attrs:{to:"/hybridclr/aot_generic/"}},[s._v("AOT泛型问题")]),s._v("。")],1),s._v(" "),t("p",[s._v("粗略地说，你补充AOT泛型类的原始元数据后，就可以实例化这个泛型类了。以上面代码为例，你补充了List类和Array.Empty函数所在的"),t("code",[s._v("mscorlib.dll")]),s._v("元数据后，就可以在热更新代码中使用任意"),t("code",[s._v("List<T>")]),s._v("泛型类了。")]),s._v(" "),t("h2",{attrs:{id:"代码中执行补充元数据"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#代码中执行补充元数据"}},[s._v("#")]),s._v(" 代码中执行补充元数据")]),s._v(" "),t("p",[s._v("使用"),t("code",[s._v("HybridCLR.RuntimeApi.LoadMetadataForAOTAssembly")]),s._v("函数为AOT泛型补充元数据，详细文档请参见"),t("RouterLink",{attrs:{to:"/hybridclr/hybridclr_unity/"}},[s._v("hybridclr_unity")]),s._v("。")],1),s._v(" "),t("div",{staticClass:"language-csharp line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-csharp"}},[t("code",[s._v("    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("static")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token return-type class-name"}},[s._v("List"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("string")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v(" AOTMetaAssemblyNames "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("get")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token constructor-invocation class-name"}},[s._v("List"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("string")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"mscorlib.dll"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"System.dll"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"System.Core.dll"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("private")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("static")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token return-type class-name"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")])]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("LoadMetadataForAOTAssemblies")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 不限补充元数据dll文件的读取方式，你可以从ab、StreamingAssets、或者裸文件下载等办法获得")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("HomologousImageMode")]),s._v(" mode "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" HomologousImageMode"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("SuperSet"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("foreach")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("var")])]),s._v(" aotDllName "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" AOTMetaAssemblyNames"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token class-name"}},[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("byte")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")])]),s._v(" dllBytes "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("GetAssetData")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("aotDllName"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 获得某个aot dll文件所有字节")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 加载assembly对应的dll，会自动为它hook。一旦aot泛型函数的native函数不存在，用解释器版本代码")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("LoadImageErrorCode")]),s._v(" err "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" RuntimeApi"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("LoadMetadataForAOTAssembly")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("dllBytes"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" mode"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n            Debug"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("Log")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token interpolation-string"}},[t("span",{pre:!0,attrs:{class:"token string"}},[s._v('$"LoadMetadataForAOTAssembly:')]),t("span",{pre:!0,attrs:{class:"token interpolation"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token expression language-csharp"}},[s._v("aotDllName")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")])]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v(". mode:")]),t("span",{pre:!0,attrs:{class:"token interpolation"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token expression language-csharp"}},[s._v("mode")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")])]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v(" ret:")]),t("span",{pre:!0,attrs:{class:"token interpolation"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token expression language-csharp"}},[s._v("err")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")])]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"')])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br")])]),t("p",[s._v("可以在任何时机加载补充元数据，只要在对应的AOT泛型使用之前即可，甚至在热更新代码中也可以随时调用这个接口来补充元数据。推荐较合理时间为加载热更新dll之前或者刚刚加载完成热更新dll，还未执行任何更新代码之前。")]),s._v(" "),t("p",[s._v("补充元数据的实现原理决定了它是可以热更的，不一定要随包带。如果上线后发现需要某个dll未补充元数据，可以通过热更新加上。不过上线后需要新增补充元数据dll的情况极少发生。")]),s._v(" "),t("h2",{attrs:{id:"应该补充元数据的assembly列表"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#应该补充元数据的assembly列表"}},[s._v("#")]),s._v(" 应该补充元数据的assembly列表")]),s._v(" "),t("p",[t("code",[s._v("HybridCLR/generate/AOTGenericReference")]),s._v(" 命令生成的 AOTGenericReferences.cs 文件中包含了应该补充元数据的assembly列表，类似这样。你不需要运行游戏也能快速知道应该补充哪些元数据。")]),s._v(" "),t("div",{staticClass:"language-csharp line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-csharp"}},[t("code",[s._v("\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// {{ AOT assemblies")]),s._v("\n\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Main.dll")]),s._v("\n\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// System.Core.dll")]),s._v("\n\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// UnityEngine.CoreModule.dll")]),s._v("\n\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// mscorlib.dll")]),s._v("\n\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// }}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br")])]),t("h2",{attrs:{id:"获得补充元数据dll"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#获得补充元数据dll"}},[s._v("#")]),s._v(" 获得补充元数据dll")]),s._v(" "),t("p",[s._v("目前支持两种元数据模式，详细文档请参见"),t("RouterLink",{attrs:{to:"/hybridclr/hybridclr_unity/"}},[s._v("hybridclr_unity")]),s._v("：")],1),s._v(" "),t("ul",[t("li",[t("code",[s._v("HomologousImageMode::Consistent")])]),s._v(" "),t("li",[t("code",[s._v("HomologousImageMode::SuperSet")])])]),s._v(" "),t("p",[s._v("如果使用 "),t("code",[s._v("HomologousImageMode::Consistent")]),s._v(" 模式，则需要使用"),t("strong",[s._v("打包过程中")]),s._v("生成的裁剪后的AOT dll，hybridclr_unity插件会自动复制到"),t("code",[s._v("{project}/HybridCLRData/AssembliesPostIl2CppStrip/{target}")]),s._v("。")]),s._v(" "),t("p",[s._v("如果使用 "),t("code",[s._v("HomologousImageMode::SuperSet")]),s._v(" 模式，你既可以像 "),t("code",[s._v("HomologousImageMode::Consistent")]),s._v(" 模式那样使用裁剪后的dll，也可以使用原始AOT dll。这在工作流上有很大便利性。")]),s._v(" "),t("p",[s._v("就跟热更新dll一样，你可以自由选择合适的方式将补充元数据dll加入你的热更新资源管理系统。既可以放StreamingAssets随包携带，也可以打ab包或裸数据等等形式。")])])}),[],!1,null,null,null);t.default=e.exports}}]);