(window.webpackJsonp=window.webpackJsonp||[]).push([[37],{357:function(t,e,s){"use strict";s.r(e);var a=s(7),n=Object(a.a)({},(function(){var t=this,e=t._self._c;return e("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[e("h1",{attrs:{id:"热更新monobehaviour"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#热更新monobehaviour"}},[t._v("#")]),t._v(" 热更新MonoBehaviour")]),t._v(" "),e("p",[t._v("HybridCLR完全支持热更新MonoBehaviour和ScriptableObject工作流，即可以在代码里在GameObject上Add热更新脚本或者在资源上直接挂载\n热更新脚本。但由于Unity资源管理机制的特殊性，对于资源上挂载热更新脚本，需要打包工作流上作一些特殊处理。")]),t._v(" "),e("h2",{attrs:{id:"通过代码使用"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#通过代码使用"}},[t._v("#")]),t._v(" 通过代码使用")]),t._v(" "),e("p",[e("code",[t._v("AddComponent<T>()")]),t._v("或者"),e("code",[t._v("AddComponent(Type type)")]),t._v("任何时候都是完美支持的。只需要提前通过Assembly.Load将热更新dll加载到运行时\n内即可。")]),t._v(" "),e("h2",{attrs:{id:"在资源上挂载monobehaviour或者创建scriptableobject类型资源"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#在资源上挂载monobehaviour或者创建scriptableobject类型资源"}},[t._v("#")]),t._v(" 在资源上挂载MonoBehaviour或者创建ScriptableObject类型资源")]),t._v(" "),e("p",[t._v("Unity资源管理系统在反序列化资源中的热更新脚本时，需要满足以下条件：")]),t._v(" "),e("ol",[e("li",[t._v("脚本所在的dll已经加载到运行时中")]),t._v(" "),e("li",[t._v("必须是使用AssetBundle打包的资源（"),e("strong",[t._v("addressable之类间接使用了ab的框架也可以")]),t._v("）")]),t._v(" "),e("li",[t._v("脚本所在的dll必须添加到打包时生成的assembly列表文件。这个列表文件是unity启动时即加载的，不可变数据。不同版本的Unity的列表文件名和格式不相同。")])]),t._v(" "),e("p",[t._v("如果未对打包流程作任何处理，由于热更新dll已经在"),e("code",[t._v("IFilterBuildAssemblies")]),t._v("回调中被移除，肯定不会出现在assembly列表文件中。\n由于不满足条件3，挂载在热更新资源中的热更新脚本无法被还原，运行时会出现 "),e("code",[t._v("Scripting Missing")]),t._v("的错误。")]),t._v(" "),e("p",[t._v("因此我们在"),e("code",[t._v("Editor/BuildProcessors/PatchScriptingAssemblyList.cs")]),t._v(" 脚本中作了特殊处理，把热更新dll加入到assembly列表文件中。\n你需要把项目中的热更新assembly添加到"),e("code",[t._v("HybridCLRSettings配置的HotUpdateAssemblyDefinitions或HotUpdateAssemblies 字段")]),t._v("中。")]),t._v(" "),e("p",[t._v("只限制了热更新资源以ab包形式打包，热更新dll打包方式没有限制。你可以按照项目需求"),e("strong",[t._v("自由选择热更新方式")]),t._v("，可以将dll打包到ab中，或者裸数据\n文件，或者加密压缩等等。只要能保证在加载热更新资源前使用Assembly.Load将其加载即可。")]),t._v(" "),e("h2",{attrs:{id:"assembly列表文件"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#assembly列表文件"}},[t._v("#")]),t._v(" assembly列表文件")]),t._v(" "),e("p",[t._v("不同Unity版本下assembly列表文件的名称和格式都不一样。")]),t._v(" "),e("ul",[e("li",[t._v("2019版本。 非压缩打包时为globalgamemanagers文件，压缩打包时先保存到globalgamemanagers文件，再以BundleFile格式和其他文件打包到data.unity3d文件。")]),t._v(" "),e("li",[t._v("2020-2021版本。 保存在ScriptingAssembles.json文件中。")])]),t._v(" "),e("h2",{attrs:{id:"已知问题"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#已知问题"}},[t._v("#")]),t._v(" 已知问题")]),t._v(" "),e("h3",{attrs:{id:"gameobject-getcomponent-string-name-接口无法获得组件"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#gameobject-getcomponent-string-name-接口无法获得组件"}},[t._v("#")]),t._v(" GameObject.GetComponent(string name) 接口无法获得组件")]),t._v(" "),e("p",[t._v("这是已知bug,跟unity的代码实现有关，只有挂载在热更新资源上热更新脚本才会有这个问题，通过代码中AddComponent添加的热更新脚本是可以用这个方法查找到。如果遇到这个问题请改用 "),e("code",[t._v("GameObject.GetComponent<T>()")]),t._v(" 或 "),e("code",[t._v("GameObject.GetComponent(typeof(T))")])]),t._v(" "),e("h2",{attrs:{id:"其它"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#其它"}},[t._v("#")]),t._v(" 其它")]),t._v(" "),e("p",[t._v("需要被挂到资源上的脚本所在dll名称上线后勿修改，因为assembly列表文件打包后无法修改。")]),t._v(" "),e("p",[t._v("建议打AB时不要禁用TypeTree，否则普通的AB加载方式会失败。（原因是对于禁用TypeTree的脚本，Unity为了防止二进制不匹配导致反序列化MonoBehaviour过程中进程Crash，会对脚本的签名进行校验，签名的内容是脚本FullName及TypeTree数据生成的Hash, 但由于我们的热更脚本信息不存在于打包后的安装包中，因此校验必定会失败）")]),t._v(" "),e("p",[t._v("如果必须要禁用TypeTree，一个变通的方法是禁止脚本的Hash校验, 此种情况下用户必须保证打包时代码与资源版本一致，否则可能会导致Crash，示例代码")]),t._v(" "),e("div",{staticClass:"language-csharp line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-csharp"}},[e("code",[t._v("    "),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("AssetBundleCreateRequest")]),t._v(" req "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" AssetBundle"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("LoadFromFileAsync")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("path"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    req"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("SetEnableCompatibilityChecks")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 非public，需要通过反射调用")]),t._v("\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br")])])])}),[],!1,null,null,null);e.default=n.exports}}]);