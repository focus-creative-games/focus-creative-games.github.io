---
title: IOS平台打包
date: 2022-05-29 20:55:59
permalink: /huatuo/ios/
categories:
  - huatuo
tags:
  - 
author: 
  name: Dongua
  link: https://github.com/ShuaiGao
---

此文档默认您已经了解了在Windows或mac下的打包构建流程，并了解了相关注意事项。

## IOS打包

Unity ios打包时会生成xcode工程，在xcode工程中并没有使用il2cpp源码（与其它平台打包不同），而是使用了提前编译好的libil2cpp.a。所以在xcode编译时需要替换成使用huatuo编译的libil2cpp.a。

编译过程使用的脚本在[huatuo仓库](https://github.com/focus-creative-games/huatuo/tree/main/scripts/iOSBuild)的 `huatuo/scripts/iOSBuild` 目录

## libil2cpp.a 编译

libil2cpp.a 的编译依赖于下面三个目录。也就是说编译 .a 使用的源文件，不是非要放到unity安装路径下的，你可以放到任意路径并构建下面的路径关系。

```
# 注意，此处是源码路径关系，不要把源码和CMakeList.txt 文件混淆
il2cpp
├─libil2cpp
│    ├─huatuo      
└─external
```

### 设置环境变量

1. huatuo 编译需要的shell和cmake脚本依赖于下面环境变量。

* HUATUO_IL2CPP_SOURCE_DIR

可以通过下面命令增加环境变量或将环境变量设置到 .zshrc 中。使用环境变量编译的好处在于编译过程中不必强行要求把拷贝移动libil2cpp目录。

```shell
# unity il2cpp 路径： 
#       /Applications/Unity/Hub/Editor/{your_unity_version}/Unity.app/Contents/il2cpp/
export HUATUO_IL2CPP_SOURCE_DIR=/your_path/il2cpp/
```

2. 另外可以通过设置环境变量`IPHONESIMULATOR_VERSION`修改iPhoneSimulator版本，未设置时使用系统默认iPhoneSimulator编译。设置示例：

```shell
export IPHONESIMULATOR_VERSION=15.5
```

### 编译il2cpp

编译过程部分步骤被合并到cmake脚本中，实际编译，只需要`cmake ..`和`make`两条命令即可

编译过程：

1. 设置环境变量
	
2. 执行gen_lump.sh 脚本<Badge text="此步骤被合并到 cmake 中，在编译完成自动执行，无需手动执行" type="error"/> 
  
    该操作模拟il2cpp在windows下的编译过程，对il2cpp的子目录生成对应的lump文件。在lump文件中会包含`il2cpp-config.h`头文件，经测试发现，il2cpp源码编译若不生成lump文件直接编译会有部分报错；原因是部分文件的头文件包含缺失导致这些文件中的宏定义出错，所以这里参考windows下的操作进行编译预处理
	
3. 创建编译目录，在目录 huatuo/scripts/iOSBuild 下执行命令
	```shell
	mkdir build
	cd build
	```

4. 执行编译命令，在目录 huatuo/scripts/iOSBuild/build 下执行命令

   ```shell
   cmake ..
   make -j4
   ```
   静态库编译完成，生成文件libil2cpp_original.a, external/libexternal.a和objective/libobjective.a

5. 合并静态库文件 <Badge text="此步骤被合并到 cmake 中，在编译完成自动执行，无需手动执行" type="error"/>
	```shell
	xcrun -r libtool -static -o libil2cpp.a libil2cpp_original.a external/libexternal.a objective/libobjective.a
	```
	
6. 编译结束，生成 libil2cpp.a。

::: warning 注意
编译生成的libil2cpp.a，如果你的文件小于120M那应该是有地方出错了，即漏掉了一部分代码，极有可能是没有替换libil2cpp文件夹，只拷贝了huatuo目录。
:::

## 其它

当前编译方式问题：

- 当前cmake文件不能通过cmke客户端工具运行，只能通过脚本执行
