---
title: 快速开始
date: 2022-05-25 11:50:18
permalink: /huatuo/start_up/
categories:
  - huatuo
tags:
  - 
author: 
  name: walon
  link: https://github.com/pirunxi
---
# huatuo

> 参考资料</br>
> **[抓狂的喜羊羊](https://space.bilibili.com/338716556)** 制作的 [huatuo尝鲜视频教程](https://www.bilibili.com/video/BV13a411a7SQ)</br>
> **[海浪](https://www.zhihu.com/people/li-dong-ri)** 制作的 [Huatuo热更框架之手把手部署](https://zhuanlan.zhihu.com/p/507361015)</br>
> **[烟雨迷离半世殇](https://www.lfzxb.top/)** 制作的[划时代的代码热更新方案huatuo从入门到掌握](https://www.bilibili.com/video/BV15F41157Tu/?spm_id_from=autoNext)


在Unity 使用il2cpp编译时 Windows、Macos、Android都是一样的，他们使用了il2cpp的源码进行编译；在ios平台代码时使用了已经编译好了il2cpp静态库文件编译，即使用了libil2cpp.a文件。本教程使用[huatuo_trial 示例项目](https://github.com/focus-creative-games/huatuo_trial)，在windows平台下操作介绍。对于ios打包操作请参照文档[IOS平台打包](/huatuo/ios/)

## 安装和环境搭建

huatuo由两部分构成[il2cpp_huatuo仓库](https://github.com/pirunxi/il2cpp_huatuo)和[huatuo仓库](https://github.com/focus-creative-games/huatuo)。il2cpp_huatuo仓库基于unity原始il2cpp作了少量修改（几百行），使得它可以支持动态注册元数据，进行可以动态加载dll。huatuo仓库是huatuo的核心源代码。

huatuo的使用基于这两部分，安装也需要**严格匹配对应版本**。具体版本限制见[支持的Unity版本](support_versions)文档。

huatuo安装方式有两种：

1. 脚本安装，在huatuo_trial项目根目录下的gen_env.sh 即为安装脚本。它会将huatuo安装到项目根目录的huatuo/project_il2cpp路径下，并在打包时通过设置 UNITY_IL2CPP_PATH 环境变量来指定使用的 il2cpp 路径

2. 使用[hutuo unity工具](https://github.com/focus-creative-games/huatuo_upm)，支持一键安装。

3. 手动安装。即将il2cpp_huatuo仓库对应分支版本的libil2cpp目录替换Editor目录下的Data/il2cpp/libil2cpp目录。将huatuo仓库的huatuo目录拷贝到Data/il2cpp/libil2cpp/目录内。

    安装过程可参照[哔哩哔哩](https://www.bilibili.com/video/BV1LZ4y1b7CR?share_source=copy_web)视频

    安装完成后目录大致如下

   ```
   il2cpp:
   ...
   +---build
   +---external
   +---libil2cpp
   |   +---codegen
   |   +---debugger
   |   +---gc
   |   +---huatuo
   |   |   CommonDef.cpp
   |   |   CommonDef.h
   |   |   HuatuoConfig.cpp
   |   |   HuatuoConfig.h
   |   |   ModuleManager.cpp
   |   |   ModuleManager.h
   |   +---icalls
   |   +---metadata
   |   +---mono
   |   +---os
   |   +---pch
   |   +---plugin
   |   +---utils
   |   +---vm
   |   huatuo-compatible-adaptor.h
   |   ...
   +---libmono
   ...
   ```

## 项目打包和启动

### 打包并启动

1. 使用对应对应Unity版本打开 huatuo_trial 项目。
2. 在菜单栏点击操作 HuaTuo->BuildBundles->ActiveBuildTarget。此操作用于编译dll并把dll打成ab包。
3. 在菜单栏点击File->Build Settings 进行打包，这里假设打包目录为huatuo_trial\build。
4. 等待打包完成后双击 huatuo.exe 运行程序；程序启动成功。

### 修改热更新代码并重新运行

1. 打开unity c#工程，并修改Assets/HotFix2/App.cs 文件。
2. 例如可以在代码Main中增加log输出 `Debug.Log("hotfix test log.");`。
3. 在菜单栏点击操作 HuaTuo->BuildBundles->ActiveBuildTarget。重新打ab包。
4. 复制目录`huatuo_trial\Assets\StreamingAssets`下的文件到`huatuo_trial\build\huatuo_Data\StreamingAssets`目录。
5. 点击huatuo.exe 重新运行程序，发现刚刚修改的日志输出代码已生效。

## 注意事项

1. huatuo的运行是基于il2cpp的，所以对于在Editor下运行的代码是没有使用huatuo的。要使用huatuo需要打包后运行。

2. huatuo目前只支持64位，其它限制如下图所示。其中：
    - script backend必须选择il2cpp
    - 热更部分 Api Compatibility Level当前只支持 .NET 4.x（unity 2021及之后版本这里显示为 .NET framework）
    - 当前不支持 Use incremental GC

::: center
![player setting](/img/huatuo/player-setting.png)
:::

3. 热更新dll不能直接从 Library/ScriptAssemblies 复制，因为它没有正确使用相应平台的编译开关。正确的实现请参考 huatuo_trail 项目 [HuatuoEditorHelper](https://github.com/focus-creative-games/huatuo_trial/blob/main/Assets/Editor/HuaTuo/HuaTuoEditorHelper.cs)中的CompileDll函数。

4. 如果你想学习huatuo源码，并调试Huatuo或者il2cpp，可以参照[Huatuo源码与调试](/huatuo/source_inspect/)。

5. 其它使用中遇到的问题可以查看[常见错误处理](/huatuo/common_errors/)。
