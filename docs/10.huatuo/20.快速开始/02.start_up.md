---
title: 快速开始
date: 2022-05-25 11:50:18
permalink: /huatuo/start_up/
categories:
  - huatuo
tags:
  - 
author: 
  name: walon
  link: https://github.com/pirunxi
---
# huatuo


在Unity 使用il2cpp编译时 Windows、Macos、Android都是一样的，他们使用了il2cpp的源码进行编译；在ios平台代码时使用了已经编译好了il2cpp静态库文件编译，即使用了libil2cpp.a文件。本教程使用[huatuo_trial 示例项目](https://github.com/focus-creative-games/huatuo_trial)，在windows平台下操作介绍。对于ios打包操作请参照文档[IOS平台打包](/huatuo/ios/)

## 安装和环境搭建

huatuo由两部分构成[il2cpp_huatuo仓库](https://github.com/pirunxi/il2cpp_huatuo)和[huatuo仓库](https://github.com/focus-creative-games/huatuo)。il2cpp_huatuo仓库基于unity原始il2cpp作了少量修改（几百行），使得它可以支持动态注册元数据，进行可以动态加载dll。huatuo仓库是huatuo的核心源代码。

huatuo的使用基于这两部分，安装也需要**严格匹配对应版本**。具体版本限制见[支持的Unity版本](support_versions)文档。

### 原理

huatuo修改和扩充了il2cpp的实现，因此使用huatuo需要打包时使用修改过的il2cpp版本。有两种方式可以达到这个目的

- 修改Unity安装目录的 Editor\Data\il2cpp\libil2cpp目录 为 huatuo相应的版本。
- Unity 打包时允许使用环境变量UNITY_IL2CPP_PATH自定义%IL2CPP_PATH%的位置，我们在合适的位置放huatuo版本的libil2cpp，然后让环境变量UNITY_IL2CPP_PATH指向它的上级il2cpp目录。
我们不推荐修改全局的UNITY_IL2CPP_PATH变量，我们已经在 huatuo_trial的 Huatuo_BuildProcessor_xxx.cs 脚本添加了自动设置局限于本进程的环境变量的代码。

```csharp
        [InitializeOnLoadMethod]
        private static void Setup()
        {
            ///
            /// unity允许使用UNITY_IL2CPP_PATH环境变量指定il2cpp的位置，因此我们不再直接修改安装位置的il2cpp，
            /// 而是在本地目录
            ///
            var projDir = Path.GetDirectoryName(Application.dataPath);
            var localIl2cppDir = $"{projDir}/HuatuoData/LocalIl2CppData/il2cpp";
            if (!Directory.Exists(localIl2cppDir))
            {
                Debug.LogError($"本地il2cpp目录:{localIl2cppDir} 不存在，请手动执行 {projDir}/HuatuoData 目录下的 init_local_il2cpp_data.bat 或者 init_local_il2cpp_data.sh 文件");
            }
            Environment.SetEnvironmentVariable("UNITY_IL2CPP_PATH", localIl2cppDir);
        }
```

我们推荐将huatuo安装到项目目录。

一个完整的huatuo版本的libil2cpp由两部分构成：

- libil2cpp 目录对应 [il2cpp_huatuo仓库](https://github.com/pirunxi/il2cpp_huatuo)/libil2cpp 目录。注意，请选择与你的Unity版本匹配的分支！！！
- libil2cpp/huatuo 目录对应 [huatuo仓库](https://github.com/focus-creative-games/huatuo)/huatuo 目录。

你可以自动手动构建这个huatuo版本的libil2cpp，但很容易出错，推荐不在熟悉的情况下，先使用 [huatuo_trial](https://github.com/focus-creative-games/huatuo_trial)
项目的安装脚本。

安装脚本的使用方式 可以参见 huatuo_trial项目的 README.md，简略如下

- 复制 huatuo_trial项目 Assets/Editor/Huatuo 目录到你的项目。
- 复制 huatuo_trial项目 HuatuoData 目录到你的项目相应位置。
- 进入HuatuoData目录
- 运行 init_huatuo_repos.bat 或 相应 .sh
- 进行 set_version_xxx.bat 或 相应 .sh。选择与你匹配的版本。如果没有匹配的版本，自己切换到正确的分支。[支持的版本与分支对应关系](https://focus-creative-games.github.io/huatuo/support_versions/)
- 运行 init_local_il2cpp_data.bat或者相应.sh文件。注意！有可能需要修改脚本，设置你的unity安装路径！

## 项目打包和启动

### 打包并启动

1. 使用对应对应Unity版本打开 huatuo_trial 项目。
2. 在菜单栏点击操作 HuaTuo->BuildBundles->ActiveBuildTarget。此操作用于编译dll并把dll打成ab包。
3. 在菜单栏点击File->Build Settings 进行打包，这里假设打包目录为huatuo_trial\build。
4. 等待打包完成后双击 huatuo.exe 运行程序；程序启动成功。

### 修改热更新代码并重新运行

1. 打开unity c#工程，并修改Assets/HotFix2/App.cs 文件。
2. 例如可以在代码Main中增加log输出 `Debug.Log("hotfix test log.");`。
3. 在菜单栏点击操作 HuaTuo->BuildBundles->ActiveBuildTarget。重新打ab包。
4. 复制目录`huatuo_trial\Assets\StreamingAssets`下的文件到`huatuo_trial\build\huatuo_Data\StreamingAssets`目录。
5. 点击huatuo.exe 重新运行程序，发现刚刚修改的日志输出代码已生效。

## 注意事项

1. huatuo的运行是基于il2cpp的，所以对于在Editor下运行的代码是没有使用huatuo的。要使用huatuo需要打包后运行。

2. huatuo目前只支持64位，其它限制如下图所示。其中：
    - script backend必须选择il2cpp
    - 热更部分 Api Compatibility Level当前只支持 .NET 4.x（unity 2021及之后版本这里显示为 .NET framework）
    - 当前不支持 Use incremental GC

::: center
![player setting](/img/huatuo/player-setting.png)
:::

3. 热更新dll不能直接从 Library/ScriptAssemblies 复制，因为它没有正确使用相应平台的编译开关。正确的实现请参考 huatuo_trail 项目 [HuatuoEditorHelper](https://github.com/focus-creative-games/huatuo_trial/blob/main/Assets/Editor/HuaTuo/HuaTuoEditorHelper.cs)中的CompileDll函数。

4. 如果你想学习huatuo源码，并调试Huatuo或者il2cpp，可以参照[Huatuo源码与调试](/huatuo/source_inspect/)。

5. 其它使用中遇到的问题可以查看[常见错误处理](/huatuo/common_errors/)。

6. 不要使用模拟器来测试Android版本！请使用真机测试，因为模拟器对64位支持不好。

7. 由于Unity的缓存机制，更新huatuo后，一定要清除Library\Il2cppBuildCache目录，不然打包时不会使用最新的代码。
如果你使用huatuo_trial项目的工作流，你可以运行HuatuoData/init_local_il2cpp_data.bat或相应.sh，脚本会自动清除这个目录。
