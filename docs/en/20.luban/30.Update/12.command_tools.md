---
title: Command Tools
date: 2022-05-25 11:14:58
permalink: /luban/command_tools/
categories:
  - luban
tags:
  - 
author: 
  name: walon
  link: https://github.com/pirunxi
---
# Introduce

## Functions and differences of Luban.Client, Luban.Server and Luban.ClientServer

The default working model of Luban is the cloud generation model, that is, Luban.Client submits the generation request to the remote Luban.Server, and Luban.Server returns the generation result to Luban.Client.
For projects that use the Luban cloud-generated working model, you need to deploy Luban.Server on a server (of course, you can also run it locally), and then change the -h parameter of Luban.Client to the IP of the server.

Luban.ClientServer is an integrated program of Luban.Client+Luban.Server, embedded with Luban.Client and Luban.Server, and its working principle is consistent with the mode of cloud generation.

Some projects are small in scale, or for individual developers who do not want to deploy Luban.Server, you can use the Luban.ClientServer tool.

## Advantages of cloud generation

In the cloud generation mode, Luban.Server will cache the generated results, and directly return the generated results for the configuration tables whose definitions and data have not changed. In daily development, only individual tables are often changed. After using cloud generation, only the data of the changed tables will be generated.
The generation time is greatly shortened, and the daily generation time is basically on the order of 300ms. For a large project like MMORPG, the daily generation is basically within 1s, which saves a considerable amount of time.

## Subordinates

There are two ways to deploy the Luban tool.

### Method 1: Luban.Client and Luban.Server are deployed independently, cloud generation mode

#### Deploy luban-server

- Based on docker (it is strongly recommended to deploy luban-server on the server in this way, because the caching mechanism can be fully utilized to greatly shorten the generation time)

     docker run -d --rm --name luban-server -p 8899:8899 focuscreativegames/luban-server:latest

- Based on .net 6 runtime (cross-platform, no need to recompile)
   - Install .net 6 runtime by yourself.
   - Copy the entire Luban.ClientServer directory from [example project](https://github.com/focus-creative-games/luban_examples/tree/main/Tools/Luban.ClientServer) (**cross-platform, even in linux, The mac platform does not need to be recompiled**)
   - Run dotnet Luban.Server.dll in the Luban.ClientServer directory (reminder: Win platform can run Luban.Server.exe directly)

#### Install luban-client

- Based on docker (only recommended for use with devops tools such as jenkins, because docker container startup will add a certain delay)

     docker run --rm -v $PWD/.cache.meta:/bin/.cache.meta focuscreativegames/luban-client &lt;parameters&gt; .

     Remind! The .cache.meta file is used to save the md5 cache of files generated locally or submitted to the remote, **strongly recommended** Add -v $PWD/.cache.meta:/bin/.cache.meta mapping, otherwise reload every time computes the md5 of all files involved, which can cause delays of up to a few seconds later in the project.
- Based on .net 6 runtime (recommended for win platform, cross-platform, no need to recompile)
   - Install .net 6 runtime by yourself.
   - Copy Luban.Client from [example project](https://github.com/focus-creative-games/luban_examples/tree/main/Tools/Luban.Client) (**cross-platform, even on linux and mac platforms No need to recompile**)

### Method 2: Client and Server integrated mode

   Client and Server run in the same process, and there is no need to deploy Luban.Server separately.

   Change the %LUBAN_CLIENT% variable in the running script from Luban.Client/Luban.Client to Luban.ClientServer/Luban.ClientServer, and **delete the -h (--host ) option and its parameters**.

   Luban.ClientServer is a functional superset of Luban.Client and can completely replace Luban.Client.

-----

## Use

### Luban-server Introduction

Command line use

    dotnet Luban.Server.dll [-p <port>] [-l <log level>]

    Parameter introduction:
    -p, --port <port>                   Optional parameter. Listen on port <port>, default is 8899.
    -l, --loglevel <log level>          Optional parameter. log level. The default is INFO. Valid values are: TRACE,DEBUG,INFO,WARN,ERROR,FATAL,OFF  
    -t, --template_search_path          Optional parameter. Additional search paths for templates. Prioritize this path, and then search for template files from the Templates directory.  
    --disable_cache                     Optional parameter. Disables caching of intermediate builds, but preserves source file caching. Useful for template debugging.
    --i10n:default_timezone  <timezone> Optional parameter. The time zone in which the datetime time is located. If not set it will try to use "Asia/Shanghai"和"China Standard Time"。

 Regarding the time zone, you can use the command "tzutil /l" under win to view the local time zone list. See also MS documentation[default-time-zones line](https://docs.microsoft.com/en-us/windows-hardware/manufacture/desktop/default-time-zones?view=windows-11)

### luban-client introduction

  Command line use

    dotnet Luban.Client.dll [-h <host>] [-p <port>] [-l <log level>] [-c <cache meta file>] [-w <watch dirs>] [-h ] -j cfg -- <job options>
    
    Parameter introduction:
    -h,--host <host>                Optional parameter. The address of luban-server. Default is 127.0.0.1
    -p,--port <port>                Optional parameter. The port of luban-server. Default is 8899
    -j,--job <job>                  Required parameter. build type. Currently supported generation types are: cfg, proto, db. Please take cfg to generate configuration.
    -l,--loglevel <log level>       Optional parameter. log level. The default is INFO. Valid values are: TRACE,DEBUG,INFO,WARN,ERROR,FATAL,OFF
    -c,--cachemetafile <meta file>  Optional parameter. The meta cache file name. The default is .cache.meta
    -w,--watch <dir1;dir2...>       Optional parameter. Monitor directories or directory lists, separated by commas ';'. When this option is turned on, the program will not exit after the generation is completed, but will enter the automatic generation mode.
                                              Automatically re-run the build after listening to changes in the target directory. Save yourself the hassle of manually running build scripts after making changes.
    --generateonly                  Optional parameter. Build only. Build results are not downloaded from the server. Can be used to check if the server can be generated successfully.
    -h,--help                       Optional parameter. show help information
    --  <job options>               Required parameter. Starting from this parameter, it is a unique option for different jobs

-----

    cfg's <job options> introduction:

    -d,--define_file <root file>            Required parameter. Root definition filename.
    --input_data_dir  <input data dir>      Required parameter. Configuration data file root directory.
    --input:convert:dir <dir>               Optional parameter. When performing data format conversions such as json, lua, and xlsx, the provided data source overrides the default input parameters in the table.
    -c,--output_code_dir <output code dir>  Optional parameter. The directory where the code files are generated.
    -s,--service                            Required parameter. Generate grouping targets. Generally speaking, several targets such as client, server, and editor are defined, and the generated content of different targets is different.

    --gen_types <type1,type2,,,>  Required parameter. Build task type. It can be either to generate code or to generate data or others.
                                  Currently supported are code_cs_bin,code_cs_unity_bin,code_cs_dotnet_json,code_cs_unity_json,
                                      code_cs_unity_editor_json,code_lua_bin,code_java_bin,code_go_bin,
                                      code_go_json,code_cpp_bin,code_cpp_ue_editor_json,code_python27_json,
                                      code_python3_json, code_gdscript_json, code_typescript_bin,code_typescript_json,code_rust_json,
                                      code_protobuf2,code_protobuf3,code_template,code_flatbuffers,
                                      data_bin,data_bidx,data_lua,data_json,data_json_monolithic,data_bson,data_yaml,
                                      data_template,data_protobuf_bin,data_protobuf_json,data_flatbuffers_json,
                                      convert_json,convert_lua,convert_xlsx,convert_template

    --validate_root_dir <path validate root dir>. Optional parameter. Configure the root directory for path checking.

    --output_data_dir <output data dir>     Optional parameter. Directory for exported data files. Can not be specified when only generating code.
    
    --output:data:compact_json                   Optional parameter. The default exported json format is an aligned elegant format, and this parameter is used to export a compact format without spaces and newlines.
    --output:data:file_extension  <output data file extension>     Optional parameter. The suffix of the exported data file. By default, it is automatically selected according to the generation type.
    --output:exclude_tags <tag1,tag2>           Optional parameter. Exclude data containing these tags when exporting
    --output:tables <table1,table2...>          Optional parameter. Manually specify which tables to export. Override the settings in the group
    --output:include_tables <table1,table2...>  Optional parameter. In addition to the settings in the group, additional tables are added
    --output:exclude_tables <table1,table2...>  Optional parameter. Exclude the tables specified in group.
    
    --output:convert:file_extension <extension> Optional parameter. The suffix of the convert data file. The default is to guess from the template name.
    
    --template:code:dir <dir name>              Optional parameter. Directory name for custom extra code templates
    --template:data:file  <template name>       Optional parameter. The name of the data template (without suffix), must be specified when gen_types contains data_template.
    --template:convert:file <template name>     Optional parameter. The name of the convert template (without the suffix), which must be specified when gen_types contains convert_template.
    

    --naming_convention:module <convention>     Optional parameter. Naming convention for template names in generated code, available values are language_recommend, none, camelCase, PascalCase, under_scores. The default is language_recommend, that is, select the naming convention style recommended by the corresponding language. This option is currently inactive.
    --naming_convention:bean_member <convention> Optional parameter. Naming convention for bean type field names in generated code, available values are language_recommend, none, camelCase, PascalCase, under_scores. Defaults to language_recommend.
    --naming_convention:enum_member <convention> Optional parameter. Naming convention for enum type names in generated code, available values are language_recommend, none, camelCase, PascalCase, under_scores. Defaults to language_recommend. This option is currently inactive.
    --access_bean_member <access mode>  Optional parameter. The access mode of the bean property. Available values are language_recommend, variable, getter_setter, property. Defaults to language_recommend. This field is currently inactive.

    --l10n:timezone <timezone>           Optional parameter. Specify your time zone. Affect datetime type conversion to utc time. The default is Beijing time, China.
    --l10n:input_text_files <file1,file2..> Optional parameter. Localized text maps. There can be more than one.
    --l10n:text_field_name <field name>     Optional parameter. In the text mapping table, the column name of the target mapping column, the default is text
    --l10n:output_not_translated_text_file <file> Optional parameter. Output file for text key and value not mapped by localization. If this parameter is not provided, it will not be generated
    --l10n:patch <patch name>                  Optional parameter. The name of the branch that needs to be generated currently.
    --l10n:patch_input_data_dir <patch data root dir> Optional parameter. Root directory for branch data.

    --typescript:bright_require_path <path>    Optional parameter. The path to the bright module referenced by the generated typescript code
    --typescript:bright_package_name <packet>  Optional parameter. Generate typescript code to reference the path of the bright library in the form of a package
    --typescript:use_puerts_bytebuf            Optional parameter. The c# Bytebuf class imported in puerts is used in the generated typescript code.
    --cs:use_unity_vector                      Optional parameter. In generating c# code, use UnityEngine.Vector{2,3,4} as the Vector data type.
    --go:bright_module_name <module path>      Optional parameter. When generating go code, the import directory of the bright module.

    --external:selectors  <selector1,selector2 ...>       Optional parameter. External class selector, can be multiple. selector must be in root.xml
    One of the selectors defined in externalselector.

#### gen_types parameter introduction

Currently supported gen_types are

- Code generation related
  - code_cs_bin               Generate the code for reading bin format data on the dotnet platform. The difference from code_cs_unity_bin is that the vector{2,3,4} type it generates isSystem.Numerics.Vector{2,3,4}
  - code_cs_unity_bin         Generate code suitable for reading bin format data for unity. The difference from code_cs_bin is that the vector{2,3,4} type it generates isUnityEngine.Vector{2,3,4}
  - code_cs_dotnet_json       Generate code for reading data in json format on the dotnet platform. The difference from code_cs_unity_json is that the vector{2,3,4} type it generates isSystem.Numerics.Vector{2,3,4}
  - code_cs_unity_json        Generate code suitable for reading json format data for unity. The difference from code_cs_dotnet_json is that the vector{2,3,4} type it generates isUnityEngine.Vector{2,3,4}
  - code_cs_unity_editor_json Generate code suitable for unity editor development. A record can be loaded or saved to a json file individually.
  - code_lua_bin              Generate lua language to read bin format code
  - code_java_bin             Generate java code to read bin format
  - code_java_json            Generate java code to read json format
  - code_go_bin               Generate code for go to read bin format
  - code_go_json              Generate code for go to read json format
  - code_cpp_bin              Generate cpp to read bin format code
  - code_cpp_ue_editor_json   Generate code suitable for UE4 editor development. A record can be loaded or saved to a json file individually
  - code_python27_json        Generate python2 series of codes to read json format
  - code_python3_json         Generate python3 series of codes to read json format
  - code_gdscript_json        Generate gdscript series to read the code in json format
  - code_typescript_bin       Generate ts code to read bin format
  - code_typescript_json      Generate ts code to read json format
  - code_rust_json            Generate code for rust to read json format
  - code_protobuf2            Generate protobuf2 schema file
  - code_protobuf3            Generate protobuf3 schema file
  - code_template             Indicates the use of custom code templates
  - code_flatbuffers          Generate flatbuffers schema file
- Data generation related
  - data_bin Export bin format data
  - data_bidx Index data in bin format. Facilitates lazy loading at the record level
  - data_lua  Export lua format data
  - data_json Export data in json format
  - data_json_monolithic。 The difference with data_json is that it generates the json data files of all tables into a json file
  - data_bson Export bson format data
  - data_yaml Export data in yaml format
  - data_xml Export data in xml format
  - data_template custom data template
  - data_protobuf_bin Export binary format data of protobuf
  - data_protobuf_json Export the json data format of protobuf3
  - data_flatbuffers_json Export the json data format of flatbuffers
  - data_resources Export all data with res tag
- Source data conversion related
  - convert_json Convert all source data to json source data format. Note that it is different from the export format. Each record occupies a file
  - convert_lua Convert all source data to lua source data format. Each record occupies a file
  - convert_xlsx Convert all source data to xlsx format. Each table occupies one file
  - convert_template Custom conversion templates. But each record occupies a file

#### .cache.meta purpose of the document

The first time a build is done, the local directory will have a .cache.meta.

.cache.meta contains information (path, md5 code, length, modification timestamp) of all files involved in the interaction with Luban.Server. Used to optimize build performance.

Since the working model of Luban.Client and Luban.Server is a cloud generation model, after Luban.Client initiates a generation request to the server, the server does not directly read the configuration file required for generation, but first obtains
The meta information (path, md5) of these files, if there is a file with the same md5 in the memory cache, it will be read directly, and the file data will not be read from the client, which greatly improves the performance of incremental generation.

After the server is generated, it will also send the generated file metadata list to the client, including (path, md5) these metadata information. If these files do not exist locally, download the download, if they already exist, check
Whether there is any change, at this time Luban.Client will not directly read the local file and calculate md5, but first check whether there is corresponding file md5 information in .cache.meta, if the length of the local file and the modification timestamp
If it is the same as that in .cache.meta, it is considered that .cache.meta contains the correct md5 value, and then compare this value with the md5 of the result generated by the server. Only if it is different, will it be re-downloaded.

## Example

Suppose:

  luban.server runs on this machine, the port is 8899
  The location of luban.client is d:\tools\Luban.Client
  Configuration definitions are in d:\raw_config\defines
  The root definition file for configuration definitions is d:\raw_config\defines\__root__.xml
  Configuration data is in d:\raw_configs\datas

  The client project is a unity project, the location is d:\client
  You expect the code generated by the client to be in the d:\client\Assets\Gen directory
  You expect the data generated by the client to be in the d:\client\Assets\StreamingAssets\GameData directory

  Your server project is a dotnet c# project, located in d:\server
  You expect the code generated by the server to be in d:\server\src\Gen
  You expect the data generated by the server to be in d:\server\GameData

### Case 1

You generate code and data for the client.
You expect the exported data type in bin format
The service you choose for the client is grouped as client
Currently in development, you expect test data to be included in the exported data

Then the command under win is:

```shell
dotnet d:\tools\Luban.Client\Luban.Client.dll ^
    -h 127.0.0.1 ^
    -p 8899 ^
    -j cfg ^
    -- ^
    --define_file d:\raw_config\defines\__root__.xml ^
    --input_data_dir d:\raw_configs\datas ^
    --output_code_dir d:\client\Assets\Gen ^
    --output_data_dir d:\client\Assets\StreamingAssets\GameData ^
    --gen_types code_cs_unity_bin,data_bin ^
    --service client
```

The same is true for linux bash commands.

### Case 2

You generate code and data for the client.
You expect to export datatypes using json format.
You don't expect the dev and test tags to be included in the exported data

Then the command under win is:

```shell
dotnet d:\tools\Luban.Client\Luban.Client.dll ^
    -h 127.0.0.1 ^
    -p 8899 ^
    -j cfg ^
    -- ^
    --define_file d:\raw_config\defines\__root__.xml ^
    --input_data_dir d:\raw_configs\datas ^
    --output_code_dir d:\client\Assets\Gen ^
    --output_data_dir d:\client\Assets\StreamingAssets\GameData ^
    --gen_types code_cs_unity_json,data_json ^
    --service client ^
    --export_exclude_tags dev,test
```

### Case 3

You generate code and data for the server.

You expect to use json export data format.
You expect to include test data.
The service you choose for the server is server

Then the command under win is:

```shell
dotnet d:\tools\Luban.Client\Luban.Client.dll ^
    -h 127.0.0.1 ^
    -p 8899 ^
    -j cfg ^
    -- ^
    --define_file d:\raw_config\defines\__root__.xml ^
    --input_data_dir d:\raw_configs\datas ^
    --output_code_dir d:\server\src\Gen ^
    --output_data_dir d:\server\GameData ^
    --gen_types code_cs_json,data_json ^
    --service server
```

### Case 4

luban-server is deployed by you on the machine 192.168.1.10, and the port is 1111. Others are as case 3.

Then the generation command under win is:
```shell
dotnet d:\tools\Luban.Client\Luban.Client.dll ^
    -h 192.168.1.10 ^
    -p 1111 ^
    -j cfg ^
    -- ^
    --define_file d:\raw_config\defines\__root__.xml ^
    --input_data_dir d:\raw_configs\datas ^
    --output_code_dir d:\server\src\Gen ^
    --output_data_dir d:\server\GameData ^
    --gen_types code_cs_dotnet_json,data_json ^
    --service server
```

### Case 5

You generate code and data for the server. At the same time, let luban.client not exit after execution and enter the monitoring state. As long as the configuration definition or data changes, the code and data will be automatically generated.

You expect to use json export data format.
You expect to include test data.
The service you choose for the server is server

Then the command under win is:

```shell
dotnet d:\tools\Luban.Client\Luban.Client.dll ^
    -h 127.0.0.1 ^
    -p 8899 ^
    -j cfg ^
    -w d:\raw_config\defines;d:\raw_configs\datas
    -- ^
    --define_file d:\raw_config\defines\__root__.xml ^
    --input_data_dir d:\raw_configs\datas ^
    --output_code_dir d:\server\src\Gen ^
    --output_data_dir d:\server\GameData ^
    --gen_types code_cs_dotnet_json,data_json ^
    --service server   
```
