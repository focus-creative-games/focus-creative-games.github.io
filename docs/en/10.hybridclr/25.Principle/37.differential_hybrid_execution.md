---
title: Differential Hybrid Execution
date: 2022-05-25 11:50:18
permalink: /hybridclr/differential_hybrid_execution/
categories:
    - HybridCLR
tags:
    -
author:
    name: walon
    link: https://github.com/pirunxi
---

# Differential Hybrid Execution

HybridCLR pioneered the implementation of Differential Hybrid Execution (DHE) differential hybrid execution technology. That is, you can add, delete, or modify the AOT dll at will, and intelligently make the changed or newly added classes and functions run in interpreter mode, but the unchanged classes and functions run in AOT mode, so that the running performance of the hot-updated game logic basically reaches the original AOT level.

We provide a [sample project](https://github.com/focus-creative-games/dhe_demo) to demonstrate the most basic DHE usage.

## Install

The main branch contains the most basic version of DHE, and the latest DHE-related functions are currently on the DHE-related branch. hybridclr_unity has a DHE branch,
The hybridclr repository has a DHE branch, and il2cpp_plus also has a {version}-DHE branch. In order to experience the latest DHE version, you need:

- Install the DHE branch of hybridclr_unity from git url
- Currently hybridclr_unity does not support branching from installation, so you need to manually install the DHE branch of hybridclr and il2cpp warehouse to your local

## Configuration

### Configure the assembly that requires differential mixed execution

Open the configuration dialog through the `HybridCLR/Settings` menu, and add the assemblies that require differential hybrid execution to differentialHybridAssemblies (differential hybrid execution dlls).

The workflow of the differential mixed execution assembly is different from that of the ordinary pure hot update assembly, because the pure hot update assembly does not need to be packaged into the main project. Therefore, the same assembly cannot be added at the same time
list of differentialHybridAssemblies and hotUpdateAssemblies.

The correct setup must be performed before any code that executes the differential hybrid execution assembly (i.e. calling `RuntimeApi::UseDifferentialHybridAOTAssembly` or `RuntimeApi::LoadDifferentialHybridAssembly`), so not all assemblies can be configured as differential hybrid execution assemblies, because mscorlib
Such a system assembly runs very early.

Fortunately, assemblies like mscorlib do not require differential mixed execution. Most game logic assemblies are executed after the hot update, which satisfies the conditions for differential mixed execution.

### Configure the export directory of the configuration data of the assembly executed by the differential hybrid

Configure `differentialHybridOptionOutputDir` field in HybridCLRSetting. Using `HybridCLR/generate/DHEAssemblyOptionDatas` will generate a `<assembly>.dhao.bytes` file for each differential hybrid assembly.

Loading a differential hybrid execution assembly requires some configuration data. For example, which functions are changed are calculated offline, so that there is no need to determine whether the function has changed at runtime. The configuration data is passed in as a parameter when calling `RuntimeApi::LoadDifferentialHybridAssembly`.

## Mark function information

Since it is only a demo version at present, it is assumed that all functions have changed by default, and you need to use `[Unchanged]` to manually mark which functions have not changed. In addition, in order to enable generic sharing of value types, you also need
Mark struct types that remain generic shared with `[Unchanged]`.

The official version will be calculated automatically, and generally you don't need to do any marking processing.

## Used in the code

At runtime, after the hot update is completed, execute the assembly for each hybrid to check whether there is a change, and if there is no change, call `RuntimeApi::UseDifferentialHybridAOTAssembly` to let
HybridCLR selects the original AOT assembly, and if it changes, it calls `RuntimeApi::LoadDifferentialHybridAssembly` to load the hot update assembly.

Note that due to Unity and il2cpp's own reasons, each mixed execution assembly needs to be preprocessed when il2cpp is initialized. So if it has not changed, be sure to call `RuntimeApi::UseDifferentialHybridAOTAssembly` to let HybridCLR restore the assembly to the AOT state, otherwise it will execute an error or even crash! ! !

Be sure to load the differential hybrid execution assembly in the order of its dependencies.

The sample code is as follows.

```csharp
void InitDifferentialHybridAssembly(string assemblyName)
{
    if (CheckNotChange(assemblyName))
    {
        RuntimeApi::UseDifferentialHybridAOTAssembly(assemblyName);
    }
    else
    {
        LoadImageErrCode err = RuntimeApi::UseDifferentialHybridAOTAssembly(GetAssemblyData(assemblyName), GetAssemblyOptionData(assemblyName));
        // ... deal with err
    }
}
```

## Package

The `HybridCLR/generate/DHEAssemblyList` command needs to be executed before packaging. Because HybridCLR needs to preprocess the differential hybrid execution assembly during the initialization stage of il2cpp, currently
Provided to HybridCLR in the form of generated assembly list code.

Examples are as follows:

```cpp
    // Il2CppCompatibleDefs.cpp file

	const char* g_differentialHybridAssemblies[]
	{

	//!!!{{DHE
        "Assembly-CSharp",
	//!!!}}DHE
		nullptr,
	};

```

Use `HybridCLR/generate/DHEAssemblyOptionDatas` to generate relevant configuration data files, and use them in conjunction with the actual project packaging process as appropriate.

## Limit

Currently Differential Hybrid Execution still has some limitations.

- Need to manually mark which functions have not changed. Subsequent versions will soon support automatic calculations.
- If the function Foo calls the function Bar in the form of a non-virtual function, and the function Bar changes, Foo must also change. If Foo is forced to be marked as unchanged, the original AOT version of the Bar function will be called by mistake , leading to incorrect results. Subsequent versions will remove this limitation.

