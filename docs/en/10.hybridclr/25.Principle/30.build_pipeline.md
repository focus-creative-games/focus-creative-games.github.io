---
title: HybridCLR packaging workflow
date: 2022-05-25 11:50:18
permalink: /hybridclr/build_pipeline/
categories:
    - HybridCLR
tags:
    -
author:
    name: walon
    link: https://github.com/pirunxi
---

# HybridCLR packaging workflow

Due to the requirements of the hot update itself and some limitations of Unity resource management, some special processing is required for the packaging workflow, which is mainly divided into several parts:

- Set the UNITY_IL2CPP_PATH environment variable
- Automatically exclude hot update assembly when packaging
- Add the hot update dll name to the assembly list when packaging
- Copy the trimmed aot dll generated during the packaging process for supplementary metadata
- Use Unity's `PlayerBuildInterface.CompilePlayerScripts` Api to compile hot update dll
- Generate some files and codes needed for packaging
- Special handling for iOS platform

We provide `com.focus-creative-games.hybridclr_unity` package [gitee (recommended)](https://gitee.com/focus-creative-games/hybridclr_unity) or [github](https://github.com/focus-creative-games/hybridclr_unity) , which contains standard tool scripts related to packaging workflows.

For more detailed implementation, please see the source code or [hybridclr_unity introduction](/en/hybridclr/hybridclr_unity/)

## Packaging process

- Refer to [HybridCLR Configuration](/en/hybridclr/project_settings/) to make necessary settings
- Run the menu `HybridCLR/Generate/All` to execute the necessary generation operations with one click
- Pack according to the original packaging process of your project
- Process the hot update dll under `HybridCLRData/HotUpdateDlls` according to the hot update resource packaging process of your project
- Process the AOT dll under `HybridCLRData/AssembliesPostIl2CppStrip` according to the hot update resource packaging process of your project

## Set the UNITY_IL2CPP_PATH environment variable

The relevant code is in `Editor/BuildProcessors/CheckSettings.cs`.

The script automatically sets or clears the UNITY_IL2CPP_PATH environment variable when packaging according to whether HybridCLR is enabled.

## Automatically exclude hot update assembly when packaging

The relevant code is in `Editor/BuildProcessors/FilterHotFixAssemblies.cs`.

Obviously, the hot update assembly should not be processed by il2cpp and compiled into the final package body. We handle the `IFilterBuildAssemblies` callback,
Remove the hot update dll from the list of build assemblies.

## Add the hot update dll name to the assembly configuration list when packaging

The relevant code is in `Editor/BuildProcessors/PatchScriptingAssemblyList.cs`.

For all C# classes, they can be used normally after Assembly.Load, but for scripts like MonoBehaviour or ScriptableObject, if you want to mount them on hot update resources
For scripts to restore correctly, issues related to Unity's resource management mechanisms must be dealt with.

Simply put, the dll name of the assembly where the hot update MonoBehaviour script is located must be added to the assembly list configuration file, so that Unity's resource management system can correctly identify it
and restore scripts. For a more detailed introduction to the principle, please see [Using Hot Update MonoBehaviour](/en/hybridclr/monobehaviour/).

When the tool is packaged, it will automatically add the dll name of the hot update assembly to the assembly list configuration file.


## Backup trimmed AOT dll

The relevant code is in `Editor/BuildProcessors/CopyStrippedAOTAssemblies.cs`.

In order to solve the AOT generic problem, we use a HybridCLR original patented technology `supplementary metadata technology`. This technique needs to provide a cropped AOT dll to resolve
il2cpp IL->c++ conversion process metadata loss problem.

In summary, in order to use AOT generics without restrictions, you need to get the trimmed AOT dll generated when packaging. The script will generate the trimmed AOT dll during the packaging process
Automatically copied to the `HybridCLRData/AssembliesPostIl2CppStrip/{platform}` directory for future processing.

The project can either choose to put the trimmed AOT dll file directly in the StreamingAssets directory of the main package, or choose to download it after packaging, and handle it flexibly according to your preferences.

For more detailed principle documents, please see [AOT Generic Principles](/en/hybridclr/aot_generic/)

## Use Unity's `PlayerBuildInterface.CompilePlayerScripts` Api to compile hot update dll

The relevant code is in `Editor/Commands/CompileDllCommand.cs`.

For each target, you must use the hot update dll compiled under the compile switch of the target platform, otherwise the hot update code will not match the code information of the AOT main package or hot update resources.

Unity will print this kind of log when there is no match: `A scripted object (probably XXX?) has a different serialization layout when loading. Did you #ifdef UNITY_EDITOR a section of your serialized properties in any of your scripts?`.

## Generate the files and code needed for packaging

Contains the following generation functions:

- Scan to generate link.xml
- generate bridge function
- Generate AOT generic instantiation code
- Generate ReversePInvokeCallback related wrapper files

The menu `HybridCLR/Generate/*` contains these generation commands. For details, please refer to [hybridclr_unity introduction](/en/hybridclr/hybridclr_unity/)

### Generate link.xml

Some classes and functions that are not used in the main project code may be used in the hot update dll, and Unity has a [code trimming mechanism](https://docs.unity3d.com/Manual/ManagedCodeStripping.html).
If some method is not used to prevent the main project classes and functions used in the hot update from being trimmed, errors such as LoadTypeException or MethodNotFoundException will occur during runtime.

The solution is to configure the link.xml file to avoid clipping. Handwriting link.xml is cumbersome and easy to miss, so a script is provided to automatically generate link.xml.

Note that the automatically generated link.xml only scans the AOT type used in the current hot update dll, it is impossible to know the type used in the future hot update dll, so manually in `Assets/link.xml` (or other non-automatic Reserved in the generated link.xml)
Types and functions that will be used in the future are necessary.

### Generate bridge function

In order to solve the two-way parameter transfer between AOT and interpreter, a bridge function is needed. Please refer to [Bridge Function Introduction](/en/hybridclr/method_bridge/) for details.

Bridge functions need to be generated before packaging.

### Generate AOT generic instantiation code

Unity has a generic sharing mechanism. For generics, if they are instantiated in AOT in advance, they will be executed natively when calling the related functions of this type in the script.

Despite the supplementary metadata mechanism, for some performance-sensitive code, early generic instantiation can significantly improve performance. For more detailed principle documents, please see [AOT Generic Principles](/en/hybridclr/aot_generic/)

### Generate ReversePInvokeCallback related wrapper files

If a scripting language such as xlua is used in the project, the `[MonoPInvokeCallback]` annotation needs to be added to the C# function to be registered in lua. This returns a corresponding C++ for these C# functions
Function pointer, used to register in the scripting language.

HybridCLR supports registering hot-updated C# code in lua, but the C++ stub function corresponding to `[MonoPInvokeCallback]` must be generated in advance to return a corresponding C++ function pointer for each C# function.
The script provides the function of automatically generating stub functions. For details, see [MonoPInvokeCallback Support](/en/hybridclr/monopinvokecallback/) and [HybridCLR+lua/js/python](/en/hybridclr/work_with_script_language/) documents

## Special handling for iOS platform

Platforms other than iOS compile `libil2cpp source code` and `c++ code converted from the original dll by il2cpp` directly to compile the target program. iOS
The platform is quite special, it uses `libil2cpp source code` to compile the libil2cpp.a file in advance, and `the c++ code converted from the original dll by il2cpp` is linked,
Compile the target program. The xcode project exported by Unity contains the pre-generated libil2cpp.a, but does not contain the libil2cpp source code.

Therefore, when compiling an iOS program, you need to compile libil2cpp.a separately, replace the corresponding file of the xcode project, and finally package the app.

For the compilation method, see [Compile iOS version libil2cpp](/en/hybridclr/build_ios_libil2cpp/). Please manually replace the corresponding files in the xcode project.
