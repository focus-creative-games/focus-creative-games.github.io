---
title: Handle AOT generics
date: 2022-09-29 12:31:29
permalink: /hybridclr/handle_aot_generic/
categories:
  - hybridclr
  - 文档
tags:
  - 
author: 
  name: Code Philosophy
  link: https://github.com/focus-creative-games
---

# Handle AOT generics

Your hot update code will always use some generics that are not used in the main project. For example, you have the following code in your hot update

```csharp
  struct MyIntVec3
  {
    public int x;
    public int y;
    public int z;
  }

  var list = new List<MyIntVec3>();
  list.Add(new MyIntVec3{x =1});

  var arr = Array.Empty<MyIntVec3>();
```

Since `List<MyIntVec3>` or `Array.Empty<MyIntVec3>` never appear in AOT, you cannot run this code in hot update without any processing.

HybridCLR uses `supplementary metadata technology` to completely solve this problem. For detailed principles, please check [AOT generic problem](/en/hybridclr/aot_generic/).

Roughly speaking, after you supplement the original metadata of the AOT generic class, you can instantiate the generic class. Taking the above code as an example, after you add the `mscorlib.dll` metadata where the List class and the Array.Empty function are located, you can use any `List<T>` generic class in the hot update code.

## Implement supplementary metadata in the code

Use `HybridCLR.RuntimeApi.LoadMetadataForAOTAssembly` function to supplement metadata for AOT generics. For detailed documentation, please refer to [hybridclr_unity](/en/hybridclr/hybridclr_unity/).

```csharp
    public static List<string> AOTMetaAssemblyNames { get; } = new List<string>()
    {
        "mscorlib.dll",
        "System.dll",
        "System.Core.dll",
    };

    private static void LoadMetadataForAOTAssemblies()
    {
        // There is no limit to the reading method of supplementary metadata dll files, you can get them from ab, StreamingAssets, or naked file downloads
        HomologousImageMode mode = HomologousImageMode.SuperSet;
        foreach (var aotDllName in AOTMetaAssemblyNames)
        {
            byte[] dllBytes = GetAssetData(aotDllName); // Get all bytes of an aot dll file
            // Load the dll corresponding to the assembly, and it will be hooked automatically. Once the native function of the aot generic function does not exist, use the interpreter version code
            LoadImageErrorCode err = RuntimeApi.LoadMetadataForAOTAssembly(dllBytes, mode);
            Debug.Log($"LoadMetadataForAOTAssembly:{aotDllName}. mode:{mode} ret:{err}");
        }
    }
```

Supplementary metadata can be loaded at any time, as long as it is before the corresponding AOT generic is used, and this interface can be called at any time even in hot update code to supplement metadata. A more reasonable time is recommended to be before the hot update dll is loaded or just after the hot update dll is loaded and before any update code is executed.


## Get supplementary metadata dll

Currently supports two metadata modes, please refer to [hybridclr_unity](/en/hybridclr/hybridclr_unity/) for detailed documentation:

- `HomologousImageMode::Consistent`
- `HomologousImageMode::SuperSet`

If you use the `HomologousImageMode::Consistent` mode, you need to use the cropped AOT dll generated during the **packaging process**, and the hybridclr_unity plugin will be automatically copied to `{project}/HybridCLRData/AssembliesPostIl2CppStrip/{target}`.

If you use `HomologousImageMode::SuperSet` mode, you can either use the clipped dll like `HomologousImageMode::Consistent` mode, or use the original AOT dll. This is a great convenience in workflow.

Just like the hot update dll, you can freely choose the appropriate way to add the supplementary metadata dll to your hot update resource management system. It can be carried in the bag with StreamingAssets, or in the form of ab package or raw data.

