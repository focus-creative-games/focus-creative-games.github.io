---
title: 桥接函数
date: 2022-05-25 11:50:18
permalink: /hybridclr/method_bridge/
categories:
  - HybridCLR
  - performance
tags:
  - 
author: 
  name: walon
  link: https://github.com/pirunxi
---
# AOT-interpreter 桥接函数

桥接函数HybridCLR的interpreter与AOT之间需要双向函数调用。比如，interpreter调用AOT函数，或者AOT部分有回调函数会调用解释器部分。

AOT部分与解释器部分的参数传递和存储方式是不一样的。比如解释器部分调用AOT函数，解释器的参数全在解释器栈上，必须借助合适的办法才能将解释器的函数参数传递给AOT函数。同样的，解释器无法直接获得AOT回调函数的参数。必须为每一种签名的函数生成对应的桥接函数，来实现解释器与aot部分的双向函数参数传递。

`interpreter -> AOT` 方向的调用，虽然可以通过ffi之类的库来完成，但函数调用的成本过高，最合理的方式仍然是提前生成好这种双向桥接函数。

解释器内部调用直接走解释器栈，不需要桥接函数。

## 桥接函数签名

不是每一个不同的函数签名都要生成一个桥接函数，大多数签名是可以共享的。例如

```csharp
int Fun1(int a, int b);
int Fun2(object a, long b);
long Fun3(long a, long b);
object Fun4(object a, object b);
```

对于x64和arm64平台, int、long、class类型共享相同的签名。因此以上Fun1-Fun4，它们都可以共享一个 "long (long, long) 签名的桥接函数。跟泛型共享规则类型，算出某个函数签名的共享桥接签名后，生成对应的桥接函数。

具体的共享规则是平台相关的，不同的abi的规则不一样。

桥接函数不同于xlua之类生成的wrap函数，大多数情况下添加了新的aot函数是不需要重新生成MethodBridge函数的。

由于我们目标是手游，主要的CPU为arm v7或者arm v8，而且arm架构的ABI比x64大多数情况下复杂多变很多。
为了避免维护过多平台的成本，以及我们希望在Win平台就能测试出所有桥接函数缺失的情况，我们索性针对32和64位各设计了一个最严格的ABI规则，
分别叫Universal32和Universal64，以及专门对手游64位平台设计了Arm64 ABI。

### Universal32 的共享规则

共享规则对函数参数和返回值均生效。

- bool, int8_t, uint8_t
- int16_t, uint16_t
- int32_t, uint32_t, pointer, ref, object
- int64_t, uint64_t
- float
- double
- ValueType_size_aligment 相同size和aligment的值类型才能共享
- 其他


### Universal64 的共享规则

共享规则对函数参数和返回值均生效。Universal64比Universal32签名规则复杂很多。

- bool, int8_t, uint8_t
- int16_t, uint16_t
- int32_t, uint32_t
- int64_t, uint64_t, pointer, ref, object
- float
- double
- ValueType_size_aligment 相同size和aligment的值类型才能共享
- ValueTypeRef 以引用方式传参
- Vector2(或者叫HFA2 float) (x,y为float类型)
- Vector3(HFA3 float)
- Vector4(FHA4 float)
- Vector2d (HFA2 double) (即x,y为double类型)
- Vector3d(HFA3 double)
- Vector4d(HFA4 double)
- HVA 2
- HVA 3
- HVA 4

### Arm64 的共享规则

- bool, int8_t, uint8_t
- int16_t, uint16_t
- int32_t, uint32_t
- int64_t, uint64_t, pointer, ref, object
- float
- double
- ValueType  size (8, 16]
- ValueType size (16, +) 以引用方式传参
- ValueType size (16, +) 以值类型返回值
- Vector2(或者叫HFA2 float) (x,y为float类型)
- Vector3(HFA3 float)
- Vector4(FHA4 float)
- Vector2d (HFA2 double) (即x,y为double类型)
- Vector3d(HFA3 double)
- Vector4d(HFA4 double)
- HVA 2
- HVA 3
- HVA 4

## HybridCLR默认桥接函数集

HybridCLR已经扫描过Unity核心库和常见的第三方库生成了默认的桥接函数集，相关代码文件为 libil2cpp/hybridclr/interpreter/MethodBridge_{abi}.cpp，其中{abi}为Universal32或Universal64。

## 自定义桥接函数集

实践项目中总会遇到一些aot函数的共享桥接函数不在默认桥接函数集中。因此提供了Editor工具，根据程序集自动生成所有桥接函数。 代码参见 [hybridclr_trial](https://github.com/focus-creative-games/hybridclr_trial) 项目

相关生成代码在 Editor/HybridCLR/Interpreter目录。菜单命令代码在Editor/HybridCLR/MethodBridgeHelper.cs中。

- 菜单 HybridCLR/MethodBridge/Universal32 生成 MethodBridge_Universal32.cpp。
- 菜单 HybridCLR/MethodBridge/Universal64 生成 MethodBridge_Universal64.cpp。

