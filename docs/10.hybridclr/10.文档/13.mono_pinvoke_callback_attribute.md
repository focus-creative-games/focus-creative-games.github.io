---
title: MonoPInvokeCallbackAttribute支持
date: 2022-05-25 11:50:18
permalink: /hybridclr/support_mono_pinvoke_callback_attribute/
categories:
  - HybridCLR
tags:
  - 
author: 
  name: walon
  link: https://github.com/pirunxi
---

# MonoPInvokeCallbackAttribute支持

HybridCLR对 `MonoPInvokeCallbackAttribute` 的支持跟原生一模一样，但需要一点点额外处理。

由于每个标注 `MonoPInvokeCallbackAttribute` 的函数有一个唯一对应的c++函数，因此要提前预留对应的c++函数。

## 具体操作

在`hybridclr/metadata/ReversePInvokeMethodStub.cpp`中，照着目前的 ____ReversePInvokeMethod_xxx的模块生成足够多（比被标记MonoPInvokeCallbackAttribute的热更新c#函数多）的此类函数即可。

接着清除 `Library/Il2CppCache`，重新打包即可。

```cpp
	void __ReversePInvokeMethod_0(void* xState)
	{
		CallLuaFunction(xState, 0);
	}

	void __ReversePInvokeMethod_1(void* xState)
	{
		CallLuaFunction(xState, 1);
	}

	Il2CppMethodPointer s_ReversePInvokeMethodStub[]
	{
		(Il2CppMethodPointer)__ReversePInvokeMethod_0,
		(Il2CppMethodPointer)__ReversePInvokeMethod_1,
		nullptr,
	};
```

更具体地说照着下面的模板，生成N=2,3,4,5... 直至足够多代码

```cpp
	void __ReversePInvokeMethod_2(void* xState)
	{
		CallLuaFunction(xState, 2);
	}
	void __ReversePInvokeMethod_3(void* xState)
	{
		CallLuaFunction(xState, 3);
	}
    // ...
	void __ReversePInvokeMethod_{N}(void* xState)
	{
		CallLuaFunction(xState, {N});
	}
```

以及在 s_ReversePInvokeMethodStub 中添加对应的项即可

```cpp
    (Il2CppMethodPointer)__ReversePInvokeMethod_2,
    (Il2CppMethodPointer)__ReversePInvokeMethod_3，
    // ...
	(Il2CppMethodPointer)__ReversePInvokeMethod_{N},
```

