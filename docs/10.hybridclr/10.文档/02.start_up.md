---
title: 快速开始
date: 2022-05-25 11:50:18
permalink: /hybridclr/start_up/
categories:
    - HybridCLR
tags:
    -
author:
    name: walon
    link: https://github.com/pirunxi
---

# HybridCLR

在Unity使用il2cpp编译时 Windows、Macos、Android 都是一样的，他们使用了 il2cpp 的源码进行编译；

打包**iOS目标平台**时使用了提前编译好的il2cpp静态库文件编译，即使用了`libil2cpp.a`文件。本教程使用[hybridclr_trial 示例项目](https://github.com/focus-creative-games/hybridclr_trial)，介绍windows 平台下的使用方式。对于 ios 打包操作请参照文档[IOS 平台打包](/hybridclr/ios/)

## 安装和环境搭建

HybridCLR 由两部分构成 [il2cpp_plus 仓库](https://github.com/focus-creative-games/il2cpp_plus) 和 [HybridCLR 仓库](https://github.com/focus-creative-games/hybridclr)。il2cpp_plus 仓库基于 unity 原始 il2cpp 作了少量修改（几百行），使得它可以支持动态注册元数据，进行可以动态加载 dll。HybridCLR 仓库是 HybridCLR 的核心源代码。

HybridCLR的安装基于这两部分，安装有一定的**版本规则**。具体见[支持的 Unity 版本](/hybridclr/support_versions/)文档。


### 原理

一个完整的 HybridCLR 版本的 libil2cpp 由两部分构成：

- libil2cpp 目录对应 [il2cpp_plus 仓库](https://github.com/focus-creative-games/il2cpp_plus) libil2cpp 目录。注意，请选择与你的 Unity 版本匹配的分支！！！
- libil2cpp/hybridclr 目录对应 [HybridCLR 仓库](https://github.com/focus-creative-games/hybridclr) hybridclr 目录。

HybridCLR 修改和扩充了 il2cpp 的实现，因此使用 HybridCLR 需要打包时使用修改过的 il2cpp 版本。有两种方式可以达到这个目的

- 修改 Unity 安装目录的`Editor\Data\il2cpp\libil2cpp`目录 为 HybridCLR 相应的版本。
- Unity 打包时允许使用环境变量`UNITY_IL2CPP_PATH`自定义`il2cpp`的位置我们在合适的位置放 HybridCLR 版本的 libil2cpp，然后让环境变量`UNITY_IL2CPP_PATH`指向它的上级 il2cpp 目录。

推荐将 HybridCLR 安装到项目目录，不推荐修改全局的`UNITY_IL2CPP_PATH`变量，我们已经在 hybridclr_trial 的`CheckSettings`脚本添加了自动设置局限于本进程的环境变量的代码。

```csharp
string curIl2cppPath = Environment.GetEnvironmentVariable("UNITY_IL2CPP_PATH");
if (curIl2cppPath != SettingsUtil.LocalIl2CppDir)
{
    Environment.SetEnvironmentVariable("UNITY_IL2CPP_PATH", SettingsUtil.LocalIl2CppDir);
    Debug.Log($"[BPCheckSettings] UNITY_IL2CPP_PATH 当前值为:'{curIl2cppPath}'，更新为:'{SettingsUtil.LocalIl2CppDir}'");
}
```

## 安装

你可以自动手动构建这个 HybridCLR 版本的 libil2cpp并且设置UNITY_IL2CPP_PATH环境变量，但很容易出错。另外，HybridCLR打包需要有一些特殊流程，无法手动完成。你需要安装[com.focus-creative-games.hybridclr_unity](https://github.com/focus-creative-games/hybridclr_unity)才能正常使用HybridCLR。

### 安装HybridCLR步骤

操作参照 [hybridclr_trial](https://github.com/focus-creative-games/hybridclr_trial) 的说明

- 安装git
- 如果你的版本低于2019.4.40、2020.3.21、2021.3.0这些最低兼容版本，则你必须额外再安装2019.4.40、2020.3.33、2021.3.1（根据你的Unity大版本），不限 f1、f1c1之类后缀。因为安装时需要从这些兼容版本的安装目录复制il2cpp目录。
- 要求当前Unity版本必须安装了 il2cpp 组件。如果未安装，请自行在UnityHub中安装。新手自行google或百度。
- 安装 visual studio，要求必须安装 `使用c++的游戏开发` 这个组件
- 确保成功安装[com.focus-creative-games.hybridclr_unity](https://github.com/focus-creative-games/hybridclr_unity) package。不熟悉package安装的请看下面的说明。
- 点击菜单 `HybridCLR/Installer...`，弹出安装界面
- 如果安装界面没有错误或者警告，则说明il2cpp路径设置正常，否则需要你手动选择正确的il2cpp目录
- 点击 install 按钮完成安装。如果安装失败，请检查git是否安装，或者安装git后未重启Unity Editor。

**已经熟悉**使用的开发人员尝试在你的项目中安装HybridCLR，安装方式如下：

安装[com.focus-creative-games.hybridclr_unity](https://github.com/focus-creative-games/hybridclr_unity) package。

为了使用HybridCLR，需要安装hybridclr_unity插件。 不熟悉从url安装package的请看 [install from git](https://docs.unity3d.com/Manual/upm-ui-giturl.html)。

由于网络原因，在unity中可能无法安装成功。你可以先把 [com.focus-creative-games.hybridclr_unity](https://github.com/focus-creative-games/hybridclr_unity) clone或者下载到本地，然后再 [install from disk](https://docs.unity3d.com/Manual/upm-ui-local.html)。

后续操作参照 [hybridclr_trial](https://github.com/focus-creative-games/hybridclr_trial)的说明

## 项目打包和启动

可以参考[视频教程](https://www.bilibili.com/video/BV1KS4y1J73a)完成项目打包。

### 打包并启动

打包前需要先在 Player Settings里作如下设置：
- script backend 必须选择 il2cpp
- Api Compatibility Level 选择 .NET 4.x（unity 2021 及之后版本这里显示为 .NET framework）
- 关闭 增量式gc 选项 (incremental gc)

目前Win64打包有**便捷**的做法，直接点击菜单 `HybridCLR->Build->Win64` 即可。

其他平台手动操作方式如下：

2. 在菜单栏点击 File->Build Settings 进行打包，这里假设打包目录为 `hybridclr_trial/build`。此次打包的目的在于生成裁剪后的dll。
3. 在菜单栏点击操作 HybridCLR->BuildBundles->ActiveBuildTarget。此操作用于编译dll并把dll打成ab包。
4. 在菜单栏点击 File->Build Settings 重新打包或将 ab包拷贝到 发布目录的 `hybridclr_trial/build/HybridCLRTrial_Data/StreamingAssets` 目录。
5. 等待打包完成后双击 HybridCLRTrial.exe 运行程序；程序启动成功。


### 修改热更新代码并重新运行

1. 打开 unity c#工程，并修改 Assets/HotFix2/App.cs 文件。
2. 例如可以在代码 Main 中增加 log 输出 `Debug.Log("hotfix test log.");`。
3. 在菜单栏点击操作 HybridCLR->BuildBundles->ActiveBuildTarget。重新打 ab 包。
4. 复制目录`hybridclr_trial\Assets\StreamingAssets`下的文件到发布目录的`hybridclr_trial\build\HybridCLRTrial_Data\StreamingAssets`目录。
5. 点击 HybridCLRTrial.exe 重新运行程序，发现刚刚修改的日志输出代码已生效。

## 注意事项

- 热更新 dll 不能直接从 Library/ScriptAssemblies 复制，因为它没有正确使用相应平台的编译开关。正确的实现请参考 hybridclr_unity package中 [HybridCLR.Editor.Commands.CompileDllCommand](https://github.com/focus-creative-games/hybridclr_unity/blob/main/Editor/Commands/CompileDllCommand.cs)中的 CompileDll 函数。
- 其它使用中遇到的问题可以查看[常见错误处理](/hybridclr/common_errors/)。
- 模拟器良好支持Android 32位，但大多数不能很好支持Android 64位。如果非要使用模拟器测试64位，请用mumu或者一些明确测试过支持64位的模拟器。
- 由于 Unity 的缓存机制，更新 HybridCLR 后，一定要清除 Library\Il2cppBuildCache 目录，不然打包时不会使用最新的代码。如果你使用Installer来自动安装或者更新HybridCLR，它会自动清除这些目录，不需要你额外操作。
