---
title: 修改Unity编辑器相关dll
date: 2022-05-29 20:55:59
permalink: /hybridclr/modify_unity_dll/
categories:
  - HybridCLR
tags:
  - 
author: 
  name: walon
  link: https://github.com/pirunxi
---


**===注意！===**，只有2021版本并且需要build iOS的开发者，才需要做以下操作。

# 原理

对于Unity 2020及更早版本，在 `IIl2CppProcessor.OnBeforeConvertRun` 事件中复制出裁剪后的AOT dll即可。

对于Unity 2021版本，除了iOS以外的target，可以在 `IPostprocessBuildWithReport.OnPostprocessBuild` 事件中复制出AOT dll。

但当target为iOS时，裁减目录与其他很不相同，在`{projectDir}/Temp/StagingArea/Data/Managed/tempStrip` 下，并且Unity在build完成后会删除这个临时目录。
Unity Editor未提供公开接口可以复制出target为iOS时的AOT dll，故只能修改UnityEditor.CoreModule.dll的代码，在生成裁剪AOT dll后，插入适当的代码，将相应dll复制到 `HybridCLRData\AssembliesPostIl2CppStrip\iOS`，供后续打包使用。

UnityEditor.CoreModule.dll 代码每个Unity版本都不一样，由于我们时间有限，**只提供了2021.3.1版本** （后面会补充更多），其他版本请自行制作。具体操作方式见下面的文档。


## 覆盖

- 提前备份 `{Editor安装目录}/Editor/Data/Managed/UnityEngine/UnityEditor.CoreModule.dll`。 UnityEditor.CoreModule.dll 具体位置有可能因为操作系统或者Unity版本而有不同。
- 如果你正好使用2021.3.1版本，则 `HybridCLRData/ModifiedUnityAssemblies/2021.3.1/UnityEditor.CoreModule-{Win,MAC}.dll` 覆盖 Editor安装目录中的 UnityEditor.CoreModule.dll。如果你使用其他版本，**则需要按下述文档自己修改 UnityEditor.CoreModule.dll**。


## 修改 UnityEditor.CoreModule.dll

Win与Mac版本的UnityEditor.CoreModule.dll并不能混用，必须单独制作。

我们使用 [dnspy](https://github.com/dnSpy/dnSpy) 来修改 dll文件。而dnspy只能在Win下运行，故哪怕是mac版本的UnityEditor.CoreModule.dll，
你也得先将相应dll复现到Win下后再修改。具体操作如下：

- 下载 [dnspy](https://github.com/dnSpy/dnSpy/releases)
- 将`{Editor安装目录}/Editor/Data/Managed/UnityEngine`目录拷贝出来，假设是TempUnityEngine目录
- 删除TempUnityEngine目录下的所有.pdb类型调试文件。**因为Unity的pdb文件有问题，会导致dnspy解析出错，导致无法保存。**
- 打开 dnspy，清除左侧的dll列表。
- 使用dnspy打开 `TempUnityEngine/UnityEditor.CoreModule.dll`
- 打开 `UnityEditorInternal.AssemblyStripper.RunAssemblyStripper` 函数， 右键菜单 -> 编辑方法(c#)...，弹出源码编辑界面。
- 此时编辑器缺少mscorlib.dll的引用，需要手动添加。点击源码编辑窗口左下角类似文件夹的按钮，添加 `{Editor安装目录}/Editor/Data/UnityReferenceAssemblies/unity-4.8-api/mscorlib.dll`。
- 在`RunAssemblyStripper`函数尾部，找到这个代码块
```csharp
	foreach (string text3 in Directory.GetFiles(fullPath))
	{
		File.Move(text3, Path.Combine(managedAssemblyFolderPath, Path.GetFileName(text3)));
	}
```
修改为 
```csharp
	string dstAOTDir = Path.Combine(UnityEngine.Application.dataPath, "../HybridCLRData/AssembliesPostIl2CppStrip", EditorUserBuildSettings.activeBuildTarget.ToString());
	Directory.CreateDirectory(dstAOTDir);
	foreach (string text3 in Directory.GetFiles(fullPath))
	{
		if (text3.EndsWith(".dll"))
		{
			string copyDstFile = Path.Combine(dstAOTDir, Path.GetFileName(text3));
			File.Copy(text3, copyDstFile, true);
			UnityEngine.Debug.Log("[RunAssemblyStripper] copy aot dll " + text3 + " -> " + copyDstFile);
		}
		File.Move(text3, Path.Combine(managedAssemblyFolderPath, Path.GetFileName(text3)));
	}
```
- 注意!反编译的代码中，变量名未必是text3，请按实际情况处理。如有遇到编译错误，请自行酌情处理。
- 点击右下角的 `编译` 按钮，如果成功，则无任何提示，退出编辑界面，返回反编译查看模式。如果失败，请自行处理编译错误。有时候dnspy会有莫名其妙的引用错误，退出源码编辑模式，重新右键`编辑方法`，再次进入就能解决。
- 菜单 `文件 -> 保存模块` 保存修改后的 UnityEditor.CoreModule.dll文件。如果在Win或Mac下，有可能会遇到权限问题，请酌情处理（比如先保存到其他位置，再手动覆盖）
- 重新打开Unity Editor。此时iOS便能正确获得裁剪AOT dll。
