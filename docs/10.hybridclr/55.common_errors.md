---
title: 常见错误
date: 2022-08-23 09:00:00
permalink: /hybridclr/common_errors/
categories:
  - HybridCLR
  - errors
tags:
  - 
author: 
  name: walon
  link: https://github.com/pirunxi
---

# 常见错误

## Unity Editor下的错误

### 打开 trial 项目，出现 `本地il2cpp目录:{localIl2cppDir} 不存在，未安装本地il2cpp。请在菜单 HybridCLR/Installer 中执行安装` 错误

需要在菜单 `HybridCLR/Installer...` 中先安装 HybridCLR，完成初始化。

### Installer点击安装出现：git不是内部或外部命令，也不是可运行的程序

需要安装git。Windows 下安装 [GitForWindows](https://gitforwindows.org/)。其他平台请自己酌情安装。

## 打包时发生错误


### Currently selected scripting backend (IL2CPP) is not installed

请在Unity Hub安装il2cpp模块。操作方式为：

- 切到UnityHub左侧的 Installers 标签页
- 你在当前使用的Unity版本上 `右键 -> Add Modules`，选中当前平台的IL2CPP组件，例如Win平台选 `Windows Build Support(Il2CPP)`
- 安装
- 重新打开Unity Editor

### `Exception: C++ code bulider is unable to build C+ code. Inorder to build C++ code for Windows Destop, You must have one of these installed. xxxxx

你没有安装 vs 及 win 10 sdk。请安装vs，并且在 Visutal Studio Installer中安装 `使用c++的游戏开发` 这个组件。 win 10 sdk选最新的即可。

## 打包时出现的问题

### 遇到Undefined symbols for architecture arm64:"Il2CppCodeGenWriteBarrier(void**, void*)", referenced from:...

取消PlayerSetting中`Increasemental GC`选项。

### 打包iOS时出现 Undefined symbols： RuntimeApi_LoadMetadataForAOTAssembly 或 HuatuoApi_LoadMetadataForAOTAssembly

因为 你使用的是原始libil2cpp.a或者过时的libil2cpp.a。请根据 [build iOS libil2cpp.a](/hybridclr/ios/) 文档编译最新的


### Android 打包遇到 additional relocation overflows omitted from the output

这个问题是由Unity 2020 Android NDK的bug引起的，在il2cpp代码生成的时候，会生成大量代码，导致编译的链接时期崩溃。在Unity 2021 版本bug被修复了。

引起这个问题一般是由于开启了Debug，只要取消掉**Development Build**选项就可以了。使用DOTS打包时设置如下图：

::: center
![DOTS设置release](/img/dots_release.png)
:::

::: tip
如果遇到这个问题，说明打包的时候代码过多了，可以检查下link.xml文件，看下是不是防裁剪配置粒度过大，导致太多代码被打包进去了。
:::  

## 运行时错误

### A scripted object (probably XXX?) has a different serialization layout when loading. Did you #ifdef UNITY_EDITOR a section of your serialized properties in any of your scripts?


不能直接从ScriptAssemblies里拷贝dll，因为可能会包含不正确的宏开关，导致引用了Editor或者其他代码。必须使用脚本编译。可参见 [HybridCLREditorHelper](https://github.com/focus-creative-games/hybridclr_trial/blob/main/Assets/Editor/HybridCLR/EditorHelper.cs) 中 CompileDll 代码。

### 挂载在资源上的脚本出现 Script Missing 错误

由于Unity的资源管理的实现机制，资源必须打包为AssetBundle才能正常恢复热更新脚本，放到Resource下不行。

详情请看 [MonoBehaviour工作流](/hybridclr/performance/MonoBehaviour/)

### 遇到  "This icall is not supported by il2cpp at System.AppDomain.Load"

有两种原因

1. 如果非ios平台，则因为未安装HybridCLR目录。请参照快速上手文档操作。
2. 如果ios平台，因为ios平台并不从源码编译libil2cpp，而是使预先编译好的libil2cpp.a，你需要替换xcode工程中的libil2cpp.a为HybridCLR的编译版本。编译方式请看[IOS Build](/hybridclr/ios/)


### unsupported internal call for il2cpp. xxxx 

调用了一个Mono中存在，但在il2cpp未实现的函数。请修改代码，不要使用这些类和函数。

### 遇到Async 调用Editor和打包后执行不一致的问题

如果代码在async里抛了异常，又没有捕获异常，会导致悄无声息失败，目前万一在async里因为裁剪或者aot泛型原因出错，会出现这种没有任何错误提示的情况。从而导致出现行为不一致。

解决方案：捕获async异常，然后解决对应异常。

### 遇到 Unity: TypeLoadException: Could not load type 'xxxx' from assembly 'netstandard'

这是因为你Player Settings里 `api compatible level` 设置为 .net standard。

目前支持.net standard 2.0，但要求主工程打包用.net standard，而热更新dll打包**必须用.net 4.x**。原因是unity使用.net standard打包时，会自动剥除.net standard的依赖，直接依赖最终的dll，导致主工程的dll列表中实际上不存在net standard这个dll，进而导致热更新dll加载时，找不到来自netstandard的对象。

解决办法为编译热更新部分时api compatible level切换为.net 4.x(2021 起改名为 .net framework)即可。


### 遇到  MissingMethodException xxx 错误

如果未出现AOT generic method的字眼，则这是unity代码裁剪引起的函数丢失，你使用常规的避免unity代码裁剪的方式处理即可。

常规两种做法

- 在link.xml preserve这个函数。
- 主工程中显式带上类或者函数的使用，如[hybridclr_trial](https://github.com/focus-creative-games/hybridclr_trial)中Assets/Main/hybridclrLib/RefTypes.cs所做的那样。

### 遇到 Unity: TypeLoadException xxx 错误

同样是unity代码裁剪引用的类型缺失。处理方法同上。

### 遇到'ExecutionEngineException: Image::ReadTypeFromResolutionScope ReadTypeFromResolutionScope.TYPEREF fail' 

由裁剪引起，裁剪的是类的内部类。处理方式同上。

### 遇到 ExecutionEngineException: metadata type not match

在 LoadMetadataForAOTAssembly 方法中，载入的dll，使用了裁剪之前的版本。应该时候裁剪之后的，具体使用可以参照hybridclr_trial项目。在BuildProcessor中，生成裁剪后的dll后，将dll拷贝到他处。

### 遇到 MissingMethodException: AOT generic method isn't instantiated in aot module xxx 错误

这是因为AOT泛型函数实例化缺失引起的，

解决办法有两个：

- 错误日志告诉你缺失哪个AOT函数实例化，你就在主工程里加上对这个函数的调用，使得il2cpp在打包时能生成这个泛型函数的代码。 主工程里任意地方加个这个泛型AOT函数调用都可以，目前一般集中加到 RefTypes.cs 这个文件里。
- 使用补充元数据技术

具体操作请看[AOT泛型限制及原理介绍](/hybridclr/performance/generic_limit/) 文档。

### 遇到ExecutionEngineException:xxx method body is null. not support external method... 

接SDK中容易遇到这个错误，这是由于不支持在热更新中定义external函数，需要放到AOT部分。

热更新代码中可以正常调用AOT中的extern函数，但不能调用解释部分的extern函数。


### 遇到 ExecutionEngineException: GetManaged2NativeMethodPointer not support. xxxx 函数名

这是因为这个AOT函数与interpreter之间的桥接函数不存在。请参考 [桥接函数](/hybridclr/performance/method_bridge/) 文档进行处理。

### 遇到'ExecutionEngineException: NotSupportNative2Managed App' 

缺失 aot -> interpreter 方向的桥接函数。

解决方法：

- 从错误日志的函数堆栈中找出最顶层函数
- 在这个函数的函数体中找到 那个导致这个桥接函数缺失的 泛型delelgate 调用（只有函数签名不太常见才可能导致出错，用经验比较好判断出来）
- 然后把delegate（等效的Action或Func也行）加到`GeneratorConfig.PrepareCustomGenericTypes` 列表。

